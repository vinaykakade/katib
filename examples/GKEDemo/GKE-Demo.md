# Simple GKE Demo
You can deploy katib components and try simple mnist demo on the cloud!

## build your training docker image
The sample code is docker-image directory.
It is based on [KubeFlow's Github issue summaraize example](https://github.com/kubeflow/examples/tree/master/github_issue_summarization/notebooks) image.

## deploy Cluster
This is grid parameter search demo for [KubeFlow's Github issue summaraize example](https://github.com/kubeflow/examples/tree/master/github_issue_summarization)

Let's deploy GKE cluster by gcloud commnad.
```
gcloud container clusters create --machine-type n1-highmem-4 --num-nodes 2 katib  
```


Then deploy Katib compenents.

```
kubectl config set-credentials temp-admin --username=admin --password=$(gcloud container clusters describe katib --format="value(masterAuth.password)")
kubectl config set-context temp-context --cluster=$(kubectl config get-clusters | grep katib) --user=temp-admin
kubectl config use-context temp-context
kubectl apply -f manifests/0-namespace.yaml
kubectl --namespace=${NAMESPACE} create secret generic gcp-credentials --from-file=key.json="${KEY_FILE}"
kubectl apply -f manifests/modeldb/db
kubectl apply -f manifests/modeldb/backend
kubectl apply -f manifests/modeldb/frontend
kubectl apply -f manifests/vizier/db
kubectl apply -f manifests/vizier/core
kubectl apply -f manifests/vizier/suggestion/random
kubectl apply -f manifests/vizier/suggestion/grid
kubectl apply -f manifests/vizier/earlystopping/medianstopping
```

In this demo, katib components does not export the port of services.
You need to start port-forward for katib services `6789 -> manager` and `3000 -> UI`.

```
$ kubectl -n katib port-forward svc/vizier-core 6789:6789 &
$ kubectl -n katib port-forward svc/modeldb-frontend 3000:3000 &
```

If you don't want to port forward, you should set firewall to allow the ports or set up Ingress.

### Push data to GCS
If you want to pull input data and push logs to google cloud storage, You need to confidurate GCP service account.

See also https://github.com/kubeflow/examples/blob/master/github_issue_summarization/training_the_model_tfjob.md

## Create Study
Run study with `go run`. you should set endpoint of vizier-core.

```
go run git-issue-summarize-demo.go -s {{ip-addr of node vizier-core deployed}}:30678
```
Katib will make 2 girds of learling-rate parameter from 0.005 to 0.5.

The `git-issue-summarize-demo.go` is a controller of this study.
It sets hyper parameter config, suggestion config, k8s job config and then, create study and run trial with katib-API.

The training logic is `docker-image/train.py`

## UI
You can check your Model with Web UI.

Acsess to `http://127.0.0.1:3000/`

The Results will be saved automatically.

## Description of git-issue-summarize-demo.go
You can make hyperparameter and evaluate it by Katib-API.
Katib-APIs are grpc. So you can use any language grpc supported(e.g. golang, python, c++).
A typical case, you will call APIs in the order as below.
In git-issue-summarize-demo.go, it wait for the status of all workers will be Completed.

### CreateStudy
First, you should create Study.
The input is StudyConfig.
It has Study name, owner, optimization info, and Parameter config(parameter name, min, and max).
This function generates a unique ID for your study and stores the config to DB.
Input:
* StudyConfig:
    * Name: string
    * Owner: string
    * OptimizationType: enum(OptimizationType_MAXIMIZE, OptimizationType_MINIMIZE)
    * OptimizationGoal: float
    * DefaultSuggestionAlgorithm: string
    * DefaultEarlyStoppingAlgorithm: string
    * ObjectiveValueName: string
    * Metrics: List of Metrics name
    * ParameterConfigs: List of parameter config.
Return:
* StudyID

### SetSuggestionParameters
Hyperparameters are generated by suggestion services with Parameter config of Study.
You can set the specific config for each suggestion.
Input: 
* StudyID: ID of your study.
* SuggestionAlgorithm: name of suggestion service (e.g. random, grid)
* SuggestionParameters: key-value pairs parameter for suggestions. The wanted key is different for each suggestion.
Return:
* ParameterID

### GetSuggestions
This function will create Trials(set of Parameters).
Input:
* StudyID: ID of your study.
* SuggestionAlgorithm: name of suggestion service (e.g. random, grid)
* RequestNumber: the number you want to evaluate.
* ParamID: ParameterID you got from SetSuggestionParameters func.
Return
* List of Trials
    * TrialID
    * Parameter Sets

### RunTrial
Start to evaluate Trial.
When you use kubernetes runtime, the pods are created the specified config.
Input:
* StudyId: ID of your study.
* TrialId: ID of Trial.
* Runtime: worker type(e.g. kubernetes)
* WorkerConfig: runtime config
    * Image: name of docker image
    * Command: running commands
    * GPU: number of GPU
    * Scheduler: scheduler name
Return:
* List of WorkerID

### GetMetrics
Get metrics of running workers.
Input:
* StudyId: ID of your study.
* WorkerIDs: List of worker ID you want to get metrics from.
Return:
* List of Metrics

### SaveModel
Save the Model date to KatibDB. After you called this function, you can look model info in the KatibUI.
When you call this API multiple time, only Metrics will be updated.
Input:
* ModelInfo
    * StudyName
    * WorkerId
    * Parameters: List of Parameter
    * Metrics: List of Metrics
    * ModelPath: path to model saved. (PVCname:mountpath)
* DataSet: informatino of input date
    * Name
    * Path: path to input data.(PVCname:mountpath)

Return:
    
### GetWorkers
You can get worker list and status of workers.
Input:
Return:
* List of worker information
